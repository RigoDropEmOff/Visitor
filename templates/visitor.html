<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Form</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<!--Nav removed, adjust CSS-->

<body>    
    <div class="container">

        <header>
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Company Logo" class="company-logo">
        </header>
        
        <h1>Welcome! Please fill out the visitor form.</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul>
                    {% for category, message in messages %}
                    <li class="flash-messages {{ category }}">{% autoescape false %}{{ message }}{% endautoescape %}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <form id="visitor-form" method="POST" enctype="multipart/form-data">

            <label for="visitor_name">Visitor Name:</label>
            <input type="text" id="visitor_name" name="visitor_name" required>

            <label for="company_name">Company Name:</label>
            <input type="text" id="company_name" name="company_name" required>

            <label for="purpose">Purpose of Visit:</label>
            <input type="text" id="purpose" name="purpose" required>

            <label for="department">Select Department:</label>
            <select id="department" name="department" required>
                <option value="" disabled selected>Select a department</option>
                <option value="HR">HR</option>
                <option value="IT">IT</option>
                <option value="Accounting">Accounting</option>
                <option value="Settlements">Settlements</option>
                <option value="Fuel">Fuel</option>
                <option value="Safety">Safety</option>
                <option value="Shop">Shop</option>
                <option value="Operations">Operations</option>
                <option value="Process">Process</option>
            </select>
            
            <label for="personnel">Select Point of Contact:</label>
            <select id="personnel" name="personnel" required>
                <option value="" disabled selected>Select a person</option>
            </select>

            <div class="photo-upload-area" id="license-photo-section">
            <label for="photo">Capture Photo:</label>
            <div class="photo-placeholder">
                <img src="/static/OIP.jpg" alt="Camera" id="camera-icon">
                <span>Click to take or upload photo</span>
                <button type="button" id="photo-button">Open Camera</button>
            </div>
            <input type="hidden" id="photo-data" name="photo_data">
            <div id="photo-preview" style="display: none;">
                <img id="preview-image" src="" alt="Preview">
                <button type="button" id="retake-photo-btn" class="btn">Retake</button>
              </div>
            </div>


            <!-- Confirmation Popup -->
            <div id="confirmation-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <p>Does the photo look correct?</p>
                <img id="popup-photo-preview" style="width: 100%; margin-top: 10px;" alt="Popup Photo Preview">
                <button type="button" id="confirm-button" style="margin-top: 10px;">Yes</button>
                <button type="button" id="retake-button" style="margin-top: 10px;">Retake</button>
            </div>

            <button id="submit-button" type="submit" style="display: none;">Submit</button>
        </form>

        <h2>Visitors Currently Checked In</h2>
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for visitor in visitors %}
            {% if not visitor.check_out_time %}
            <tr>
                <td>{{ visitor.name }}</td>
                <td>
                    <form method="POST" action="{{ url_for('visitor_checkout', visitor_id=visitor.id) }}">
                        <button type="submit" class="checkout-button">Check Out</button>
                    </form>
                </td>
            </tr>
            {% endif %}
        {% endfor %}
    </tbody>
</table>


<script>
document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM loaded - initializing photo capture functionality");
    
    // Get all necessary elements
    const photoButton = document.getElementById("photo-button");
    const photoDataInput = document.getElementById("photo-data");
    const photoPreview = document.getElementById("photo-preview");
    const previewImage = document.getElementById("preview-image");
    const retakePhotoBtn = document.getElementById("retake-photo-btn");
    const cameraIcon = document.getElementById("camera-icon");
    const submitButton = document.getElementById("submit-button");
    const visitorForm = document.getElementById("visitor-form");
    
    // Create confirmation popup if it doesn't exist
    let popup = document.getElementById("confirmation-popup");
    if (!popup) {
        popup = document.createElement("div");
        popup.id = "confirmation-popup";
        popup.style.cssText = `
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 500px;
            text-align: center;
        `;
        
        popup.innerHTML = `
            <p>Does the photo look correct?</p>
            <img id="popup-photo-preview" style="width: 100%; margin-top: 10px;" alt="Photo Preview">
            <div style="margin-top: 15px;">
                <button type="button" id="confirm-button" style="margin-right: 10px; padding: 8px 16px;">Yes</button>
                <button type="button" id="retake-button" style="padding: 8px 16px;">Retake</button>
            </div>
        `;
        document.body.appendChild(popup);
    }
    
    const popupPhotoPreview = document.getElementById("popup-photo-preview");
    const confirmButton = document.getElementById("confirm-button");
    const retakeButton = document.getElementById("retake-button");
    
    // Create a hidden file input for photo capture
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.capture = "camera"; // This tells the browser to prefer using the camera
    fileInput.style.display = "none";
    document.body.appendChild(fileInput);
    
    // Photo button handler - use simple file input approach
    photoButton.addEventListener("click", function() {
        console.log("Photo button clicked");
        fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
            console.log("Photo file selected:", file.name);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imageData = e.target.result;
                console.log("Image loaded, showing preview");
                
                // Show preview in confirmation popup
                popupPhotoPreview.src = imageData;
                photoDataInput.value = imageData;
                popup.style.display = "block";
            };
            
            reader.readAsDataURL(file);
        }
    });
    
    // Confirm Photo
    confirmButton.addEventListener("click", function() {
        console.log("Photo confirmed");
        popup.style.display = "none"; // Hide popup
        
        // Show the preview in the main UI
        previewImage.src = photoDataInput.value;
        photoPreview.style.display = "block";
        
        // If submit button exists, show it
        if (submitButton) {
            submitButton.style.display = "block";
        }
    });
    
    // Retake Photo
    retakeButton.addEventListener("click", function() {
        console.log("Retaking photo");
        popup.style.display = "none"; // Hide popup
        photoDataInput.value = ""; // Clear the hidden input
        fileInput.value = ""; // Clear the file input
        fileInput.click(); // Reopen file selection
    });
    
    // Retake photo button in main UI
    retakePhotoBtn.addEventListener("click", function() {
        console.log("Retake button clicked from preview");
        photoPreview.style.display = "none"; // Hide the preview
        photoDataInput.value = ""; // Clear the data
        fileInput.value = ""; // Clear the file input
        fileInput.click(); // Reopen file selection
    });
    
    // Department change handler (keeping this from your previous code)
    const departmentSelect = document.getElementById("department");
    const personnelSelect = document.getElementById("personnel");
    
    if (departmentSelect && personnelSelect) {
        departmentSelect.addEventListener("change", function() {
            const selectedDepartment = this.value;
            console.log("Department changed to:", selectedDepartment);
            
            // Clear current options in personnel select
            personnelSelect.innerHTML = '<option value="" disabled selected>Select a person</option>';
            
            // If a department is selected, fetch personnel for that department
            if (selectedDepartment) {
                console.log("Fetching personnel for department:", selectedDepartment);
                fetch(`/get_personnel?department=${selectedDepartment}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("Personnel data received:", data);
                        // Add new options based on the response
                        if (data && data.length > 0) {
                            data.forEach(person => {
                                const option = document.createElement("option");
                                option.value = person.email;
                                option.textContent = person.name;
                                personnelSelect.appendChild(option);
                            });
                            console.log("Added personnel options:", data.length);
                        } else {
                            console.log("No personnel data found for department");
                        }
                    })
                    .catch(error => console.error("Error fetching personnel:", error));
            }
        });
    }
});
</script>
    </div>
</body>
</html>
