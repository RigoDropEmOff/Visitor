<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Form</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<!--Nav removed, adjust CSS-->

<body>    
    <div class="container">

        <header>
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Company Logo" class="company-logo">
        </header>
        
        <h1>Welcome! Please fill out the visitor form.</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul>
                    {% for category, message in messages %}
                    <li class="flash-messages {{ category }}">{% autoescape false %}{{ message }}{% endautoescape %}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <form id="visitor-form" method="POST" enctype="multipart/form-data">

            <label for="visitor_name">Visitor Name:</label>
            <input type="text" id="visitor_name" name="visitor_name" required>

            <label for="company_name">Company Name:</label>
            <input type="text" id="company_name" name="company_name" required>

            <label for="purpose">Purpose of Visit:</label>
            <input type="text" id="purpose" name="purpose" required>

            <label for="department">Select Department:</label>
            <select id="department" name="department" required>
                <option value="" disabled selected>Select a department</option>
                <option value="HR">HR</option>
                <option value="IT">IT</option>
                <option value="Accounting">Accounting</option>
                <option value="Settlements">Settlements</option>
                <option value="Fuel">Fuel</option>
                <option value="Safety">Safety</option>
                <option value="Shop">Shop</option>
                <option value="Operations">Operations</option>
                <option value="Process">Process</option>
            </select>
            
            <label for="personnel">Select Point of Contact:</label>
            <select id="personnel" name="personnel" required>
                <option value="" disabled selected>Select a person</option>
            </select>

            <div class="photo-upload-area" id="license-photo-section">
            <label for="photo">Capture Photo:</label>
            <div class="photo-placeholder">
                <img src="/static/OIP.jpg" alt="Camera" id="camera-icon">
                <span>Click to take or upload photo</span>
                <button type="button" id="photo-button">Open Camera</button>
            </div>
            <input type="hidden" id="photo-data" name="photo_data">
            <div id="photo-preview" style="display: none;">
                <img id="preview-image" src="" alt="Preview">
                <button type="button" id="retake-photo-btn" class="btn">Retake</button>
              </div>
            </div>


            <!-- Confirmation Popup -->
            <div id="confirmation-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <p>Does the photo look correct?</p>
                <img id="popup-photo-preview" style="width: 100%; margin-top: 10px;" alt="Popup Photo Preview">
                <button type="button" id="confirm-button" style="margin-top: 10px;">Yes</button>
                <button type="button" id="retake-button" style="margin-top: 10px;">Retake</button>
            </div>

            <button id="submit-button" type="submit" style="display: none;">Submit</button>
        </form>

        <h2>Visitors Currently Checked In</h2>
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for visitor in visitors %}
            {% if not visitor.check_out_time %}
            <tr>
                <td>{{ visitor.name }}</td>
                <td>
                    <form method="POST" action="{{ url_for('visitor_checkout', visitor_id=visitor.id) }}">
                        <button type="submit" class="checkout-button">Check Out</button>
                    </form>
                </td>
            </tr>
            {% endif %}
        {% endfor %}
    </tbody>
</table>


<script>
// Add this to your existing script section in visitor.html
document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM fully loaded - initializing visitor form");
    
    // Get all necessary elements
    const departmentSelect = document.getElementById("department");
    const personnelSelect = document.getElementById("personnel");
    const photoButton = document.getElementById("photo-button");
    const visitorForm = document.getElementById("visitor-form");
    
    // Create hidden photo data input if not exists
    let photoDataInput = document.getElementById("photo-data");
    if (!photoDataInput) {
        photoDataInput = document.createElement("input");
        photoDataInput.type = "hidden";
        photoDataInput.id = "photo-data";
        photoDataInput.name = "photo_data";
        visitorForm.appendChild(photoDataInput);
    }
    
    // Create popup elements if they don't exist
    let popup = document.getElementById("confirmation-popup");
    if (!popup) {
        popup = document.createElement("div");
        popup.id = "confirmation-popup";
        popup.style.cssText = `
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 500px;
            text-align: center;
        `;
        
        popup.innerHTML = `
            <p>Does the photo look correct?</p>
            <img id="popup-photo-preview" style="width: 100%; margin-top: 10px;" alt="Photo Preview">
            <div style="margin-top: 15px;">
                <button type="button" id="confirm-button" style="margin-right: 10px; padding: 8px 16px;">Yes</button>
                <button type="button" id="retake-button" style="padding: 8px 16px;">Retake</button>
            </div>
        `;
        document.body.appendChild(popup);
    }
    
    const popupPhotoPreview = document.getElementById("popup-photo-preview");
    const confirmButton = document.getElementById("confirm-button");
    const retakeButton = document.getElementById("retake-button");
    
    // Create submit button if it doesn't exist
    let submitButton = document.getElementById("submit-button");
    if (!submitButton) {
        submitButton = document.createElement("button");
        submitButton.id = "submit-button";
        submitButton.type = "submit";
        submitButton.innerText = "Submit Visitor Information";
        submitButton.style.cssText = `
            display: none;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        `;
        visitorForm.appendChild(submitButton);
    } else {
        submitButton.style.display = "none";
    }
    
    // Department change handler
    departmentSelect.addEventListener("change", function() {
        const selectedDepartment = this.value;
        console.log("Department changed to:", selectedDepartment);
        
        // Clear current options in personnel select
        personnelSelect.innerHTML = '<option value="" disabled selected>Select a person</option>';
        
        // If a department is selected, fetch personnel for that department
        if (selectedDepartment) {
            console.log("Fetching personnel for department:", selectedDepartment);
            fetch(`/get_personnel?department=${selectedDepartment}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Personnel data received:", data);
                    // Add new options based on the response
                    if (data && data.length > 0) {
                        data.forEach(person => {
                            const option = document.createElement("option");
                            option.value = person.email;
                            option.textContent = person.name;
                            personnelSelect.appendChild(option);
                        });
                        console.log("Added personnel options:", data.length);
                    } else {
                        console.log("No personnel data found for department");
                    }
                })
                .catch(error => console.error("Error fetching personnel:", error));
        }
    });
    
    // Photo button handler
    photoButton.addEventListener("click", function() {
        console.log("Photo button clicked");
        
        // Check if the MediaDevices API is supported
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log("MediaDevices API supported");
            
            // Create video and canvas elements for capturing
            const videoElement = document.createElement("video");
            videoElement.autoplay = true;
            videoElement.style.display = "none";
            document.body.appendChild(videoElement);
            
            const canvasElement = document.createElement("canvas");
            canvasElement.style.display = "none";
            document.body.appendChild(canvasElement);
            
            // Access camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    console.log("Camera access granted");
                    videoElement.srcObject = stream;
                    
                    // Create snapshot UI
                    const snapshotDiv = document.createElement("div");
                    snapshotDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0,0,0,0.8);
                        z-index: 1000;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    const previewVideo = document.createElement("video");
                    previewVideo.autoplay = true;
                    previewVideo.srcObject = stream;
                    previewVideo.style.cssText = "width: 80%; max-height: 60vh; object-fit: contain;";
                    
                    const takePhotoBtn = document.createElement("button");
                    takePhotoBtn.textContent = "Take Photo";
                    takePhotoBtn.style.cssText = "margin-top: 20px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px;";
                    
                    const cancelBtn = document.createElement("button");
                    cancelBtn.textContent = "Cancel";
                    cancelBtn.style.cssText = "margin-top: 10px; padding: 10px 20px; background-color: #f44336; color: white; border: none; border-radius: 4px;";
                    
                    snapshotDiv.appendChild(previewVideo);
                    snapshotDiv.appendChild(takePhotoBtn);
                    snapshotDiv.appendChild(cancelBtn);
                    document.body.appendChild(snapshotDiv);
                    
                    // Event listener to take a photo
                    takePhotoBtn.addEventListener("click", () => {
                        console.log("Take photo button clicked");
                        
                        // Set canvas dimensions
                        const width = previewVideo.videoWidth;
                        const height = previewVideo.videoHeight;
                        canvasElement.width = width;
                        canvasElement.height = height;
                        
                        // Capture the photo from video stream
                        const context = canvasElement.getContext("2d");
                        context.drawImage(previewVideo, 0, 0, width, height);
                        
                        // Convert to Base64 format
                        let imageData = canvasElement.toDataURL("image/jpeg");
                        
                        // Show preview in confirmation popup
                        popupPhotoPreview.src = imageData;
                        photoDataInput.value = imageData;
                        popup.style.display = "block";
                        
                        // Cleanup: Stop video stream and remove UI elements
                        stream.getTracks().forEach(track => track.stop());
                        document.body.removeChild(snapshotDiv);
                        document.body.removeChild(videoElement);
                        document.body.removeChild(canvasElement);
                    });
                    
                    // Cancel button event listener
                    cancelBtn.addEventListener("click", () => {
                        console.log("Cancel button clicked");
                        stream.getTracks().forEach(track => track.stop());
                        document.body.removeChild(snapshotDiv);
                        document.body.removeChild(videoElement);
                        document.body.removeChild(canvasElement);
                    });
                })
                .catch(error => {
                    console.error("Error accessing camera:", error);
                    // Fallback to file input if camera access fails
                    const input = document.createElement("input");
                    input.type = "file";
                    input.accept = "image/*";
                    
                    input.addEventListener("change", () => {
                        const file = input.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                popupPhotoPreview.src = e.target.result;
                                photoDataInput.value = e.target.result;
                                popup.style.display = "block";
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    
                    input.click();
                });
        } else {
            console.log("MediaDevices API not supported");
            alert("Camera access is not supported on this device. Please use a different device or browser.");
        }
    });
    
    // Confirm Photo
    confirmButton.addEventListener("click", () => {
        console.log("Confirm button clicked");
        popup.style.display = "none"; // Hide popup
        submitButton.style.display = "block"; // Show submit button
    });
    
    // Retake Photo
    retakeButton.addEventListener("click", () => {
        console.log("Retake button clicked");
        popup.style.display = "none"; // Hide popup
        photoDataInput.value = ""; // Clear the hidden input
        photoButton.click(); // Trigger photo capture again
    });
});
</script>
    </div>
</body>
</html>
